# 完善远程语音通讯软件开发计划

我已完成代码库调研，发现现有的 `src/room-manager.js` 功能非常完善但未被 `signaling-server.js` 使用，且 P2P 连接已内置了 STUN 服务器配置。

本计划将通过整合现有模块并开发新功能，实现从"创建房间"到"远程连接"的完整闭环。

## 核心任务分解

### 1. 后端：整合房间管理逻辑
**目标**：启用 `RoomManager` 接管房间生命周期，确保房间 ID 唯一且状态可控。
- **重构 `src/signaling-server.js`**：
    - 引入 `src/room-manager.js` 实例。
    - 改造 `handleJoin` 逻辑：区分 `create`（调用 `roomManager.createRoom`）和 `join`（调用 `roomManager.joinRoom`）。
    - 增加错误处理：返回具体的错误码（如 `ROOM_FULL`, `ROOM_NOT_FOUND`）。

### 2. 协议与链接：实现深度链接 (Deep Linking)
**目标**：支持通过链接直接唤起应用并加入房间。
- **修改 `src/main.js`**：
    - 注册自定义协议 `voicechat://`。
    - 监听 `open-url` 事件（macOS）和 `second-instance` 事件（Windows），解析 URL 中的 Room ID。
    - 通过 IPC 将 Room ID 发送给渲染进程。
- **链接生成策略**：
    - 格式定为：`voicechat://room/{ROOM_ID}`（用于唤起应用）和 `https://gamevoice.app/join/{ROOM_ID}`（用于分享，需配合落地页，暂时仅实现协议链接）。

### 3. 前端：增强连接与交互
**目标**：完善 UI 反馈，支持复制链接和自动加入。
- **更新 `ui/App.jsx`**：
    - **房间控制区**：
        - 增加 "复制邀请链接" 按钮（生成 `voicechat://room/ABCD`）。
        - 增加 "复制邀请码" 按钮。
    - **自动加入逻辑**：
        - 监听主进程的 `join-room-via-link` 消息，自动填入 Room ID 并触发加入流程。
    - **状态反馈**：
        - 细化错误提示（如"房间已满"、"连接超时"）。
- **更新 `src/signaling-client.js`**：
    - 适配新的服务器协议，正确处理 `room-created` 和 `error` 响应。

### 4. 网络优化 (已部分就绪)
- **确认配置**：`src/p2p-manager.js` 已包含 Google STUN 服务器，无需额外开发，只需确保配置正确透传。
- **增强建议**：在 UI 设置中保留 "使用 TURN 服务器" 选项（暂时置灰或预留接口）。

### 5. 测试与验证
- **集成测试**：编写脚本模拟两个客户端连接同一个房间。
- **手动验证**：
    - 验证 Windows 下通过命令行 `start voicechat://room/123` 是否能唤起应用并填入 ID。

## 执行步骤

1.  **后端改造**：修改 `src/signaling-server.js` 对接 `RoomManager`。
2.  **前端适配**：更新 `src/signaling-client.js` 和 `ui/App.jsx`。
3.  **协议注册**：修改 `src/main.js` 支持 URL Scheme。
4.  **UI 完善**：添加分享按钮和链接处理逻辑。
5.  **验证交付**：运行测试并确认功能。
