# 解决音频设备选择与权限问题的方案

## 问题诊断
用户反馈无法选择音频设备，经分析主要原因是 **Electron 主进程未处理媒体权限请求** 以及 **渲染进程未在枚举设备前正确获取权限**，导致设备列表可能为空或没有名称（label）。

## 实施计划

### 1. 主进程权限处理 (`src/main.js`)
*   **目标**: 自动批准渲染进程的媒体（麦克风）权限请求，防止静默失败。
*   **操作**:
    *   在 `createWindow` 函数中，为 `session` 添加 `setPermissionRequestHandler`。
    *   明确允许 `media` 和 `audioCapture` 权限。

### 2. 音频管理器优化 (`src/audio-manager.js`)
*   **目标**: 解决设备列表无名称（label 为空）的问题，确保用户能看到设备名。
*   **操作**:
    *   修改 `getAudioDevices` 方法。
    *   添加检测逻辑：如果获取到的设备列表存在空 label，则尝试调用一次 `navigator.mediaDevices.getUserMedia({ audio: true })` 来触发系统权限弹窗。
    *   获取权限成功后，关闭流并重新枚举设备。

### 3. 构建配置更新 (`electron-builder.json`)
*   **目标**: 确保 macOS 打包后包含必要的权限声明（虽然用户可能是 Windows，但这是最佳实践）。
*   **操作**:
    *   添加 `mac.extendInfo` 字段，声明 `NSMicrophoneUsageDescription`。

## 验证方法
1.  修改代码后，重启应用 (`npm start`)。
2.  观察控制台日志，确认权限请求被自动批准。
3.  打开设置面板，检查音频设备下拉列表是否显示了真实的设备名称（而非 "Default" 或空白）。
4.  尝试切换设备，确认能正常工作。
